<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>POS System - Integración Microservicios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .sticky-top { top: 20px; }
        .card-scroll { max-height: 300px; overflow-y: auto; }
        .table-sm { font-size: 0.85rem; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid px-4 py-3">
    <div class="row g-3">
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people"></i> Clientes</span>
                    <button class="btn btn-sm btn-outline-light" onclick="mostrarModalCliente()">+</button>
                </div>
                <div class="card-body card-scroll p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Nombre</th><th>Acción</th></tr></thead>
                        <tbody>
                            <tr th:each="c : ${clientes}">
                                <td th:text="${c.nombre}"></td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" th:onclick="'eliminarCliente(' + ${c.id} + ')'"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-box"></i> Inventario</span>
                    <button class="btn btn-sm btn-outline-light" onclick="mostrarModalProducto()">+</button>
                </div>
                <div class="card-body card-scroll p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Nombre</th><th>Stock</th><th>Precio</th><th>Acción</th></tr></thead>
                        <tbody>
                            <tr th:each="p : ${productos}">
                                <td th:text="${p.nombre}"></td>
                                <td th:text="${p.stock}"></td>
                                <td th:text="'$' + ${p.precio}"></td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" th:onclick="'eliminarProducto(' + ${p.id} + ')'"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-cart-fill"></i> Punto de Venta (Carrito)
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="small">Cliente de la Factura:</label>
                            <select id="selCliente" class="form-select">
                                <option value="">-- Seleccionar --</option>
                                <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="small">Agregar Producto:</label>
                            <select id="selProducto" class="form-select" onchange="agregarAlCarrito(this)">
                                <option value="">-- Buscar Producto --</option>
                                <option th:each="p : ${productos}" th:value="${p.id}" 
                                        th:data-precio="${p.precio}" th:data-nombre="${p.nombre}"
                                        th:text="${p.nombre} + ' ($' + ${p.precio} + ')'"></option>
                            </select>
                        </div>
                    </div>

                    <table class="table table-sm" id="tablaCarrito">
                        <thead class="table-light"><tr><th>Item</th><th>Cant</th><th>Sub</th><th></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="sticky-top">
                <div class="card shadow border-primary border-2">
                    <div class="card-body">
                        <h5 class="text-center mb-3">Resumen Legal</h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="resSubtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-primary">
                            <span>IVA (Tax-Service):</span>
                            <span id="resIva">$0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between h4 mb-4">
                            <span>TOTAL:</span>
                            <span id="resTotal" class="text-success">$0.00</span>
                        </div>
                        <button class="btn btn-success w-100 py-3 fw-bold" onclick="generarFactura()">
                            <i class="bi bi-printer me-2"></i>GENERAR FACTURA
                        </button>
                    </div>
                </div>
                <div class="mt-3 small text-muted text-center">
                    <i class="bi bi-hdd-network"></i> Status: Connected to <b>tax-service:8081</b>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let carrito = [];
    let subtotal = 0;

    function agregarAlCarrito(select) {
        const option = select.options[select.selectedIndex];
        if (!option.value) return;

        const item = {
            id: parseInt(option.value),
            nombre: option.getAttribute('data-nombre'),
            precio: parseFloat(option.getAttribute('data-precio')),
            cantidad: 1
        };

        const existe = carrito.find(i => i.id === item.id);
        if (existe) { existe.cantidad++; } else { carrito.push(item); }
        
        recalcular(); 
        select.value = "";
    }

    async function recalcular() {
        subtotal = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
        
        const lblSubtotal = document.getElementById('resSubtotal');
        const lblIva = document.getElementById('resIva');
        const lblTotal = document.getElementById('resTotal');
        const btnGenerar = document.querySelector('button[onclick="generarFactura()"]');

        lblSubtotal.innerText = `$${subtotal.toFixed(2)}`;

        lblIva.innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span>';
        btnGenerar.disabled = true;

        if (subtotal === 0) {
            lblIva.innerText = "$0.00";
            lblTotal.innerText = "$0.00";
            btnGenerar.disabled = false;
            renderCarrito();
            return;
        }

        try {
            const response = await fetch(`/api/facturas/calcular-previa?subtotal=${subtotal}`);
            
            if (response.ok) {
                const taxData = await response.json();
                
                lblIva.innerText = `$${taxData.iva.toFixed(2)}`;
                lblTotal.innerText = `$${taxData.total.toFixed(2)}`;
            } else {
                console.error("Error calculando impuestos");
                lblIva.innerText = "Error";
            }
        } catch (e) {
            console.error("Error de conexión:", e);
            lblIva.innerText = "Sin conexión";
        } finally {
            // 6. Rehabilitar botón y actualizar tabla
            btnGenerar.disabled = false;
            renderCarrito();
        }
    }

    function renderCarrito() {
        const tbody = document.querySelector("#tablaCarrito tbody");
        tbody.innerHTML = carrito.map((item, index) => `
            <tr>
                <td>${item.nombre}</td>
                <td>${item.cantidad}</td>
                <td>$${(item.precio * item.cantidad).toFixed(2)}</td>
                <td><button class="btn btn-sm text-danger" onclick="remover(${index})">x</button></td>
            </tr>
        `).join('');
    }

    function remover(index) {
        carrito.splice(index, 1);
        recalcular();
    }

    async function generarFactura() {
        const clienteId = document.getElementById('selCliente').value;
        if (!clienteId || carrito.length === 0) return alert("Seleccione cliente y productos");

        const payload = {
            cliente: { id: parseInt(clienteId) },
            detalles: carrito.map(i => ({ producto: { id: i.id }, cantidad: i.cantidad }))
        };

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

        try {
            const response = await fetch('/api/facturas', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("✅ Factura generada con éxito. PDF enviado por correo.");
                location.reload();
            } else {
                alert("❌ Error: " + await response.text());
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-printer me-2"></i>GENERAR FACTURA';
            }
        } catch (e) {
            alert("❌ Error de comunicación");
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-printer me-2"></i>GENERAR FACTURA';
        }
    }

    function eliminarProducto(id) { if(confirm('¿Eliminar?')) fetch('/api/productos/'+id, {method:'DELETE'}).then(()=>location.reload()); }
    function eliminarCliente(id) { if(confirm('¿Eliminar?')) fetch('/api/clientes/'+id, {method:'DELETE'}).then(()=>location.reload()); }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>